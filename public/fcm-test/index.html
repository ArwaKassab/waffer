<!doctype html>
<html lang="ar">
<head>
    <meta charset="utf-8"/>
    <title>اختبار FCM للويب</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        body { font-family: sans-serif; max-width:800px; margin:20px auto; }
        textarea{ width:100%; height:120px; }
        .error{color:#b00020}
    </style>
</head>
<body>
<h1>اختبار إشعارات FCM للويب</h1>

<p>
    <button id="btnPerm">تفعيل الإشعارات</button>
    <button id="btnCopy">نسخ التوكن</button>
</p>

<h3><label for="tokenBox">FCM Token</label></h3>
<textarea id="tokenBox" readonly aria-label="FCM Token"></textarea>
<div id="err" class="error"></div>

<h3>الرسائل (Foreground)</h3>
<div id="messages" style="border:1px solid #ddd; padding:10px; min-height:100px;"></div>

<!-- 1) حمّلي الإعدادات من السيرفر -->
<script src="public/firebase-config.js"></script>

<!-- 2) مكتبات compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
    const errBox = document.getElementById('err');
    const showErr = (e) => { console.error(e); errBox.textContent = e?.message || String(e); };

    // تهيئة من الملف الديناميكي
    firebase.initializeApp(window._FIREBASE.config);
    const messaging = firebase.messaging();
    const VAPID_PUBLIC_KEY = window._FIREBASE.vapidPublicKey;

    async function enableNotifications() {
        try {
            if (!firebase.messaging.isSupported()) throw new Error('Firebase Messaging غير مدعوم في هذا المتصفح.');

            const perm = await Notification.requestPermission();
            if (perm !== 'granted') throw new Error('الإذن مرفوض. من Site settings → Notifications → Allow ثم Reload.');

            // مهم: التسجيل من الجذر
            const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js', { scope: '/' });

            const token = await messaging.getToken({
                vapidKey: VAPID_PUBLIC_KEY,
                serviceWorkerRegistration: reg,
            });
            if (!token) throw new Error('getToken رجّع null. تحققي من VAPID وسENDER_ID.');

            document.getElementById('tokenBox').value = token;
            console.log('FCM token:', token);
        } catch (e) { showErr(e); }
    }

    messaging.onMessage((payload) => {
        const box = document.getElementById('messages');
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(payload.data ?? payload, null, 2);
        box.prepend(pre);
    });

    document.getElementById('btnPerm').addEventListener('click', enableNotifications);
    document.getElementById('btnCopy').addEventListener('click', () => {
        const t = document.getElementById('tokenBox'); t.select(); document.execCommand('copy');
    });

    // تحقّق دعم SW
    if (!('serviceWorker' in navigator)) showErr('هذا المتصفح لا يدعم Service Workers');
</script>
</body>
</html>
